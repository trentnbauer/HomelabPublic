version: '3'
services:
  autoheal:
    deploy:
      replicas: 1
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: 60
      AUTOHEAL_START_PERIOD: 240
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60
      AUTOHEAL_ONLY_MONITOR_RUNNING: true
      WEBHOOK_URL: ${PUSHOVER_WEBHOOK:-""}
    image: willfarrell/autoheal@sha256:6176a79899bc9694a7f54b60eeaed092b331bf6406f4af5eecfde3142e9fbea0
    network_mode: none
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
  
  prunemate-proxy:
    network_mode: host
    image: ghcr.io/tecnativa/docker-socket-proxy:v0.4.2
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ALLOW_START=1
      - ALLOW_STOP=1
      - ALLOW_RESTART=1
      - IMAGES=1
      - CONTAINERS=1
      - VOLUMES=1
      - NETWORKS=1
      - POST=1
    healthcheck:
      test: wget --spider http://localhost:2375/version || exit 1
      interval: "29s"
      timeout: "5s"
      retries: 3
      start_period: "21s"
    labels:
      - autoheal=true
      
  watchtower:
    image: ghcr.io/containrrr/watchtower:1.7.1
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-Australia/Melbourne}
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_LABEL_ENABLE=true

  beszel-agent:
    image: ghcr.io/henrygd/beszel/beszel-agent:0.17.0@sha256:a68e3fe37fccd49d7132dbd6bdc98155e5160fe122b070c38aa1eca090c98a7d
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - LISTEN=${BESZELPORT:-45876}
      - KEY=$BESZELKEY
      - GPU="true"
    healthcheck:
      test: ['CMD', '/agent', 'health']
      start_period: 30s
      interval: 120s
      retries: 3
      timeout: 60s
    labels:
      - autoheal=true

  dockflare-proxy:
    image: tecnativa/docker-socket-proxy:v0.4.1
    restart: unless-stopped
    logging:
      driver: "none"  # Minimize the logs, remove for verbose
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - CONTAINERS=1
      - EVENTS=1
      - NETWORKS=1
      - IMAGES=1
      - POST=1
      - PING=1
      - INFO=1
      - EXEC=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - dockflare

  dockflare-init:
    image: alpine:3.20
    command: ["sh", "-c", "chown -R ${DOCKFLARE_UID:-65532}:${DOCKFLARE_GID:-65532} /app/data"]
    volumes:
      - dockflare_app:/app/data
    networks:
      - dockflare
    restart: "no"

  dockflare-app:
    image: alplat/dockflare:stable@sha256:d5d77c1caeb3a82467499371dd5e7c9ab7c2c03c527d4f1465062b755aa7c8ca
    restart: unless-stopped
    ports:
      - ${DOCKFLAREPORT:-5000}:5000
    environment:
      - TUNNEL_NAME=${CF_TUNNELNAME:-MissingHostname}
      - CLOUDFLARED_NETWORK_NAME=dockflare
      - CLOUDFLARED_IMAGE=cloudflare/cloudflared:2025.11.1
      - REDIS_URL=redis://dockflare-db:6379/0
      - REDIS_DB_INDEX=0
      - DOCKER_HOST=tcp://dockflare-proxy:2375
      - TZ=${TZ:-Australia/Melbourne}
      - CF_API_TOKEN=${CF_APITOKEN}
      - CF_ACCOUNT_ID=${CF_ACCOUNTID}
      - CLEANUP_INTERVAL_SECONDS=3600
      - GRACE_PERIOD_SECONDS=28800
      - CLEANUP_INTERVAL_SECONDS=900
      - AGENT_STATUS_UPDATE_INTERVAL_SECONDS=15
      - SCAN_ALL_NETWORKS=true
      - MAX_CONCURRENT_DNS_OPS=1
      - SYNC_ALL_CLOUDFLARE_POLICIES=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - dockflare_app:/app/data
    labels:
      - autoheal=true
      - dockflare.enable=true
      - dockflare.0.hostname=${CF_TUNNELNAME:-MissingHostname}.dockflare.${URLTLD}
      - dockflare.0.service=http://${HOSTNAME:-localhost}:${DOCKLAREPORT:-5000}
      - dockflare.0.access.policy=default_tld
      - dockflare.0.zonename=${URLTLD}
      #- cloudflare.tunnel.path=${URLPATH:-}
    depends_on:
      dockflare-proxy:
        condition: service_started
      dockflare-init:
        condition: service_completed_successfully
      dockflare-db:
        condition: service_started
    networks:
      - dockflare

  dockflare-db:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    logging:
      driver: "none"  # less logs, remove for verbose / more logs
    volumes:
      - dockflare_db:/data
    networks:
      - dockflare
      
  portracker:
    image: mostafawahied/portracker:1.2.2@sha256:4464bc74d909f54cf29df5f4d44f8e2190e589219b9d092b48ba054077ab4582
    restart: unless-stopped
    network_mode: "host"
    pid: "host"
    volumes:
      - portacker:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DATABASE_PATH=/data/portracker.db
      - PORT=${PORTACKERPORT:-4999}
    labels:
      - autoheal=true
      - dockflare.enable=true
      - dockflare.0.hostname=${CFTUNNELNAME:-MissingHostname}-portracker.${URLTLD}
      - dockflare.0.service=http://${HOSTNAME:-localhost}:${PORTACKERPORT:-4999}
      - dockflare.0.access.policy=default_tld
      - dockflare.0.zonename=${URLTLD}
      #- cloudflare.tunnel.path=${URLPATH:-}

volumes:
  dockflare_app:
  dockflare_db:
  portacker:

networks:
  dockflare: 

services:
  engine:
    image: crowdsecurity/crowdsec:v1.7.6@sha256:63b595fef92de1778573b375897a45dd226637ee9a3d3db9f57ac7355c369493
    labels:
      - AH.CS.PVE=true
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    restart: unless-stopped
    ports:
      - ${CROWDSEC_PORT:-8080}:8080
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      - COLLECTIONS=crowdsecurity/linux crowdsecurity/sshd crowdsecurity/linux-lpe crowdsecurity/iptables fulljackz/proxmox
      - ENROLL_INSTANCE_NAME=${CROWDSEC_NAME}
      - BOUNCER_KEY_FIREWALL=${BOUNCER_KEY}
      - DISABLE_LOCAL_API=false
      - DISABLE_ONLINE_API=false
      - ENROLL_KEY=${CROWDSEC_ENROLL_KEY}
    volumes:
      - data:/var/lib/crowdsec/data
      - config:/etc/crowdsec
      - bouncer:/etc/bouncer-shared
      - /var/log:/var/log:ro
    healthcheck:  
      test: ["CMD", "cscli", "version"]
      interval: 15s
      timeout: 10s
      retries: 5
    networks:
      crowdsec:
        aliases:
          - crowdsec

  bouncer:
    image: ghcr.io/shgew/cs-firewall-bouncer-docker:v0.0.34@sha256:ff1b5b0972ea0cfe39a4f10728effc38f6185a88b742fc4ad5a53d5dca80aca1
    labels:
      - AH.CS.PVE=true
    deploy:
      restart_policy:
        condition: on-failure
        delay: 60s
        max_attempts: 6
        window: 60s
    restart: unless-stopped
    network_mode: host
    depends_on:
      engine:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - no-new-privileges:true
    environment:
      - API_URL=http://localhost:${CROWDSEC_PORT:-8080}/
      - API_KEY=${BOUNCER_KEY}
    volumes:
      - bouncer:/config:rw
      - /etc/localtime:/etc/localtime:ro

  pve-sync:
    image: alpine:3.23.2
    container_name: crowdsec-pve-sync
    network_mode: host
    depends_on:
      engine:
        condition: service_healthy
    environment:
      - PVE_URL=https://localhost:${PVE_PORT:-8006}/api2/json
      - PVE_TOKEN_ID=${PVE_TOKEN_ID}
      - PVE_TOKEN_SECRET=${PVE_TOKEN_SECRET}
      - LAPI_URL=http://localhost:${CROWDSEC_PORT:-8080}/v1
      - LAPI_KEY=${BOUNCER_KEY}
    command: >
      sh -c "apk add --no-cache curl jq &&
      while true; do
        echo 'Checking for new bans...'
        # Get bans from CrowdSec
        CS_BANS=$$(curl -s -H \"X-Api-Key: $$LAPI_KEY\" $$LAPI_URL/decisions | jq -r '.[].value' | sort)
        
        # Get bans from Proxmox (using // empty to handle null results gracefully)
        PVE_BANS=$$(curl -s -k -H \"Authorization: PVEAPIToken=$$PVE_TOKEN_ID=$$PVE_TOKEN_SECRET\" \
          \"https://localhost:${PVE_PORT:-8006}/api2/json/cluster/firewall/ipset/crowdsec_bans\" | jq -r '.data[].cidr // empty' | sort)
        
        # Add new bans
        for ip in $$CS_BANS; do
          if ! echo \"$$PVE_BANS\" | grep -q \"$$ip\"; then
            echo \"Adding $$ip to Proxmox...\"
            curl -s -k -X POST -H \"Authorization: PVEAPIToken=$$PVE_TOKEN_ID=$$PVE_TOKEN_SECRET\" \
              -d \"cidr=$$ip\" \"https://localhost:${PVE_PORT:-8006}/api2/json/cluster/firewall/ipset/crowdsec_bans\" > /dev/null
          fi
        done
        
        # Remove expired bans
        for ip in $$PVE_BANS; do
          if ! echo \"$$CS_BANS\" | grep -q \"$$ip\"; then
            echo \"Removing $$ip from Proxmox...\"
            curl -s -k -X DELETE -H \"Authorization: PVEAPIToken=$$PVE_TOKEN_ID=$$PVE_TOKEN_SECRET\" \
              \"https://localhost:${PVE_PORT:-8006}/api2/json/cluster/firewall/ipset/crowdsec_bans/$$ip\" > /dev/null
          fi
        done
        sleep 300;
      done"

  init:
    image: alpine:3.23.2
    volumes:
      - config:/etc/crowdsec
      - bouncer:/etc/crowdsec/bouncers
    command: >
      sh -c "apk add --no-cache wget ca-certificates &&
             mkdir -p /etc/crowdsec/acquisitions.d /etc/crowdsec/bouncers &&
             wget -qO /etc/crowdsec/acquisitions.d/pve.yaml https://raw.githubusercontent.com/trentnbauer/HomelabPublic/main/crowdsec/pve.yaml &&
             wget -qO /etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml https://raw.githubusercontent.com/trentnbauer/HomelabPublic/main/crowdsec/crowdsec-firewall-bouncer.yaml"

  autoheal:
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 5
        window: 120s
    environment:
      AUTOHEAL_CONTAINER_LABEL: AH.CS.PVE
      AUTOHEAL_INTERVAL: 60
      AUTOHEAL_START_PERIOD: 240
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60
      WEBHOOK_URL: ${AUTOHEAL_WEBHOOK:-}
    image: willfarrell/autoheal@sha256:835876066495c243e562f9e28ec691c6a84d4d50bfe7c8a1c3d0ec72cf5f322a
    restart: always
    network_mode: none
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock

networks:
  crowdsec:

volumes:
  config:
  data:
  bouncer:
